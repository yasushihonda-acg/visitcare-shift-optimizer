# VisitCare シフト最適化システム 操作マニュアル

> **対象読者**: サービス提供責任者（サ責）、管理者
> **アプリURL**: https://visitcare-shift-optimizer.web.app

---

## 目次

1. [ログイン](#1-ログイン)
2. [画面構成の概要](#2-画面構成の概要)
3. [スケジュール画面](#3-スケジュール画面)
4. [最適化の実行](#4-最適化の実行)
5. [手動編集](#5-手動編集)
6. [週の切り替え](#6-週の切り替え)
7. [マスタ管理](#7-マスタ管理)
8. [最適化実行履歴](#8-最適化実行履歴)
9. [権限について](#9-権限について)

---

## 1. ログイン

### 本番環境（認証必須モード）

1. ブラウザで https://visitcare-shift-optimizer.web.app にアクセス
2. ログイン画面が表示されます
3. **「Google でログイン」** ボタンをクリック
4. 組織の Google アカウントを選択してログイン

ログイン後、ヘッダー右上にロール（`管理者` / `サ責` / `ヘルパー`）とユーザー名が表示されます。

### ログアウト

1. ヘッダー右上の **歯車アイコン** をクリック
2. メニュー最下部の **「ログアウト」** を選択

---

## 2. 画面構成の概要

アプリは以下の画面で構成されています。

| 画面 | パス | 説明 |
|------|------|------|
| スケジュール | `/` | メイン画面。ガントチャートで週間シフトを表示 |
| 利用者マスタ | `/masters/customers` | 利用者の一覧・編集 |
| ヘルパーマスタ | `/masters/helpers` | ヘルパーの一覧・編集 |
| 希望休管理 | `/masters/unavailability` | 希望休の登録・編集 |
| 最適化実行履歴 | `/history` | 過去の最適化実行結果一覧 |

マスタ管理と実行履歴へは、ヘッダー右上の **歯車アイコン** のドロップダウンメニューからアクセスできます。

---

## 3. スケジュール画面

スケジュール画面はメイン画面で、以下の要素で構成されています。

### 3.1 ヘッダー

- **VisitCare** ロゴ: クリックでスケジュール画面に戻る
- **週セレクター**: 現在表示中の週（`M/d - M/d` 形式）
- **ロールバッジ**: ログインユーザーのロール表示
- **歯車メニュー**: マスタ管理・実行履歴へのナビゲーション

### 3.2 曜日タブ

ヘッダーの下に月曜〜日曜の7つのタブが表示されます。

- 各タブにはその曜日の **オーダー件数** がバッジで表示されます
- タブをクリックすると、その曜日のスケジュールに切り替わります
- 選択中のタブは下線付きのアクティブ表示になります

### 3.3 StatsBar（統計バー）

曜日タブの下に4つの統計カードが並びます。

| カード | 説明 |
|--------|------|
| **オーダー** | 選択中の曜日のオーダー総数 |
| **割当済** | 割当済みオーダー数と割当率（%）。プログレスバー付き |
| **未割当** | 未割当オーダー数。1件以上の場合は黄色で強調表示 |
| **ヘルパー** | 稼働ヘルパー数。制約違反がある場合は赤色バッジ（違反数）、黄色バッジ（警告数）が表示 |

### 3.4 ガントチャート

メインエリアにはヘルパーごとのガントチャートが表示されます。

- **縦軸**: ヘルパー名
- **横軸**: 時間帯（タイムスケール）
- **バー**: 各オーダーがサービス種別ごとに色分けされたバーで表示
  - 青系: 身体介護
  - 緑系: 生活援助
  - 紫系: 介護予防
- **未割当セクション**: 画面下部に未割当のオーダーが表示されます

バーをクリックすると、オーダー詳細パネルが開きます。

---

## 4. 最適化の実行

### 4.1 基本手順

1. スケジュール画面の曜日タブ右側にある **「最適化実行」** ボタンをクリック
2. ダイアログが開き、対象週が表示されます
3. 必要に応じて「詳細設定」でパラメータを調整（後述）
4. **「テスト実行」** または **「実行」** をクリック

### 4.2 テスト実行と本実行の違い

| | テスト実行 | 本実行 |
|---|---|---|
| 最適化計算 | 実行する | 実行する |
| Firestoreへの書き戻し | **しない** | する |
| スケジュール画面の更新 | されない | リアルタイムに反映 |
| 用途 | パラメータ調整の確認 | 確定した割当を保存 |

### 4.3 パラメータ調整（詳細設定）

ダイアログ内の **「詳細設定」** をクリックすると、以下の重み付けスライダーが表示されます。

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| 移動時間最小化 | 1.0 | ヘルパーの移動時間を短くする度合い |
| 推奨スタッフ優先 | 5.0 | 推奨スタッフへの割当を優先する度合い |
| 稼働バランス | 10.0 | ヘルパー間の稼働時間を均等にする度合い |
| 担当継続性 | 3.0 | 同じ利用者に同じヘルパーを割り当てる度合い |

- スライダーは 0.0〜20.0 の範囲で 0.5 刻みで調整可能
- **「リセット」** ボタンでデフォルト値に戻せます
- 値が大きいほど、その要素がより重視されます

### 4.4 実行結果

実行完了後、トースト通知で結果が表示されます。

- **成功**: `最適化完了: XX/YY件割当 (Z.Z秒)` — 割当件数と実行時間
- **テスト成功**: `最適化（テスト）完了: XX/YY件割当 (Z.Z秒)`
- **エラー**: 赤色トーストでエラー内容が表示されます

---

## 5. 手動編集

### 5.1 ドラッグ&ドロップによるスタッフ変更

ガントチャート上のオーダーバーをドラッグして、別のヘルパーの行にドロップすることで割当を変更できます。

1. 移動したいオーダーのバーを長押し（5px以上移動で開始）
2. ドロップ先のヘルパー行にドラッグ
3. ドロップゾーンが緑色に光ればドロップ可能、赤色の場合は制約違反
4. ドロップすると即座にFirestoreに保存されます

### 5.2 オーダー詳細パネルでのスタッフ変更

1. ガントチャート上のオーダーバーをクリック
2. 画面右側からオーダー詳細パネルがスライドイン
3. パネルには以下の情報が表示されます:
   - **基本情報**: 利用者名、時間、サービス種別、ステータス
   - **割当スタッフ**: 現在割当されているヘルパー一覧
   - **制約違反**: 該当オーダーの制約違反一覧（ある場合）
   - **住所**: 利用者の住所
4. 「割当スタッフ」セクションのセレクターで、割当スタッフを変更できます
   - 複数スタッフの選択が可能です
   - 変更は即座にFirestoreに保存されます

### 5.3 最適化差分表示

最適化実行後、スタッフ割当が変更されたオーダーには差分バッジが表示されます。オーダー詳細パネルで変更前後の比較を確認できます。

---

## 6. 週の切り替え

ヘッダー中央の週セレクターで表示週を切り替えます。

### 操作方法

- **前の週へ**: `<` ボタンをクリック
- **次の週へ**: `>` ボタンをクリック
- **カレンダーから選択**: 日付表示部分をクリック → カレンダーポップアップから任意の日付を選択
  - 選択した日付を含む週（月曜始まり）に自動で切り替わります
- **今週に戻る**: カレンダーポップアップ下部の「今週に戻る」ボタン（今週以外を表示中のみ表示）

---

## 7. マスタ管理

ヘッダー右上の歯車アイコンからアクセスします。

### 7.1 利用者マスタ (`/masters/customers`)

利用者の一覧を表示・管理します。

**一覧表示**:
- 氏名、住所、サ責、サービス日数、NG/推奨スタッフ数が表示
- 上部の検索ボックスで名前・住所を絞り込み可能

**新規追加** (管理者・サ責のみ):
1. 「新規追加」ボタンをクリック
2. 編集ダイアログで情報を入力して保存

**編集** (管理者・サ責のみ):
1. 行右端の鉛筆アイコンをクリック
2. 編集ダイアログで情報を更新して保存

**編集ダイアログの項目**:
- 氏名（姓・名）
- 住所
- サービス提供責任者
- NGスタッフ / 推奨スタッフ
- 週間サービス設定（曜日ごとのサービス内容・時間帯）

### 7.2 ヘルパーマスタ (`/masters/helpers`)

ヘルパーの一覧を表示・管理します。

**一覧表示**:
- 氏名、資格、身体介護可否、雇用形態、移動手段、勤務日数、希望時間が表示
- 名前・資格で検索可能

**新規追加** (管理者のみ):
1. 「新規追加」ボタンをクリック
2. 編集ダイアログで情報を入力して保存

**編集** (管理者のみ):
1. 行右端の鉛筆アイコンをクリック
2. 編集ダイアログで情報を更新して保存

**編集ダイアログの項目**:
- 氏名（姓・名）
- 資格
- 身体介護可否
- 雇用形態（常勤 / 非常勤）
- 移動手段（車 / 自転車 / 徒歩）
- 希望稼働時間（最小〜最大）
- 週間勤務可能時間帯

### 7.3 希望休管理 (`/masters/unavailability`)

スタッフの希望休を週単位で管理します。

**一覧表示**:
- スタッフ名、不在内容（曜日・時間帯）、備考が表示
- 上部に週ナビゲーション（`<` / `>`）で対象週を切り替え
- スタッフ名で検索可能

**新規追加** (管理者・サ責、ヘルパーは自分のみ):
1. 「新規追加」ボタンをクリック
2. 対象スタッフ、不在日時（終日 or 時間指定）、備考を入力して保存

**編集**:
1. 行右端の鉛筆アイコンをクリック
2. 内容を更新して保存

---

## 8. 最適化実行履歴

歯車メニュー → **「実行履歴」** からアクセスします。

### 8.1 一覧画面 (`/history`)

過去の最適化実行結果がテーブルで表示されます。

| 列 | 説明 |
|----|------|
| 実行日時 | 最適化を実行した日時 |
| 対象週 | 最適化対象の週（月曜日の日付） |
| ステータス | 結果のバッジ表示 |
| 割当 | 割当件数 / 全オーダー数 |
| 実行時間 | ソルバーの実行時間（秒） |
| 目的関数値 | 最適化の目的関数値（低いほど良い） |

**ステータスバッジ**:
- **最適解** (緑): 最適な割当が見つかった
- **実行可能解** (黄): 割当は見つかったが最適ではない可能性がある
- **テスト** (グレー): テスト実行（Firestoreへの書き戻しなし）
- **赤バッジ**: エラーまたは実行不可

### 8.2 詳細パネル

一覧の行をクリックすると、右側にスライドパネルが開き、詳細情報が表示されます。

- 実行日時、対象週、ステータス
- 実行時間、割当率、目的関数値、制限時間
- **割当結果テーブル**: 各オーダーIDと担当スタッフ名の一覧

---

## 9. 権限について

ログインユーザーのロールによって操作できる範囲が異なります。

| 操作 | 管理者 | サ責 | ヘルパー |
|------|--------|------|----------|
| スケジュール閲覧 | ○ | ○ | ○ |
| 最適化実行 | ○ | ○ | - |
| 手動割当変更 | ○ | ○ | - |
| 利用者マスタ編集 | ○ | ○ | - |
| ヘルパーマスタ編集 | ○ | - | - |
| 希望休管理（全員） | ○ | ○ | - |
| 希望休管理（自分のみ） | - | - | ○ |
| 実行履歴閲覧 | ○ | ○ | ○ |
